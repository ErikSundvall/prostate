<!DOCTYPE html>
<!-- NOTE: SVG files in this demo/ directory are auto-generated from src/assets/ during build.
     Do not edit them directly - modify the source files in src/assets/ instead. -->
<html>
  <head>
    <meta charset="utf-8" />
    <title>Prostate MRI Map Demo</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body {
        font-family: system-ui, Segoe UI, Roboto, Arial;
        margin: 16px;
      }
      /* CSS variables for palette overrides */
      prostate-mri-map {
        --pirads-1: #FFFFB2;
        --pirads-2: #FD8D3C;
        --pirads-3: #FB6A4A;
        --pirads-4: #DE2D26;
        --pirads-5: #A50F15;
      }
    </style>
    <!-- Shoelace theme CSS is still required so the popup is styled correctly. -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.20.1/cdn/themes/light.css">
  </head>
  <body>
    <h1>Prostate MRI Map - Demo (placeholder)</h1>
    <p>
      Language: <select id="lang">
        <option value="en">en</option>
        <option value="sv">sv</option>
      </select>
    </p>
    <p>
      Dataset: <select id="dataset">
        <option value="example-1.json">example-1.json</option>
        <option value="example-2.json">example-2.json (one overlap)</option>
        <option value="example-3.json">example-3.json (faulty indata, errors expected)</option>
        <option value="example-4.json">example-4.json (several overlaps)</option>
      </select>
    </p>
    <p>
      Map used: <select id="map-selector">
        <option value="prostate-map.svg">prostate-map.svg</option>
        <option value="prostate-map-2.svg">prostate-map-2.svg</option>
      </select>
    </p>
    <prostate-mri-map id="map" language="en"></prostate-mri-map>

    <script type="module">
      // Try to load the bundled component if present in demo/. If the bundle
      // doesn't exist (dev workflow without bundling), fall back to the
      // inline renderer below.
      let _haveBundle = false;
      try {
        await import('./prostate-mri-map.bundle.js');
        _haveBundle = !!customElements.get('prostate-mri-map');
      } catch (err) {
        // bundle not present or failed to load â€” we'll use the inline demo
        // script that manipulates the slotted SVG directly.
        _haveBundle = false;
        console.debug('Bundle not loaded, falling back to inline demo renderer.', err);
      }
    </script>

    <script>
      // Lightweight demo script that supports two modes:
      //  - component mode (if the bundled `prostate-mri-map` is loaded)
      //  - inline mode (fallback) which manipulates the slotted SVG directly

  const container = document.getElementById("map");
      let currentData = null;
      // color map (PI-RADS)
      const PI_RADS_COLORS = {
        5: "#A50F15",
        4: "#DE2D26",
        3: "#FB6A4A",
        2: "#FD8D3C",
        1: "#FFFFB2",
      };

      function getPiradsColor(p) {
        p = Math.max(1, Math.min(5, Math.round(Number(p) || 1)));
        return PI_RADS_COLORS[p];
      }

      function computeZoneState(lesions) {
        const CANONICAL = [];
        for (let g = 1; g <= 4; g++) {
          for (const letter of ["A", "B", "C"]) {
            for (const suffix of ["v", "d"]) CANONICAL.push(`${g}${letter}${suffix}`);
          }
        }
        const result = {};
        for (const z of CANONICAL) result[z] = { highestPirads: null, lesionIds: [], count: 0 };
        for (const lesion of lesions || []) {
          const id = String(lesion.id || "");
          const p = Number(lesion.pirads || 0) || 0;
          for (const z of lesion.zones || []) {
            const zid = String(z).trim();
            if (!result[zid]) result[zid] = { highestPirads: null, lesionIds: [], count: 0 };
            const st = result[zid];
            st.lesionIds.push(id);
            st.count = st.lesionIds.length;
            if (st.highestPirads === null || p > st.highestPirads) st.highestPirads = p;
          }
        }
        return result;
      }

      function applyZoneStylesToSvg(svg, zoneState) {
        if (!svg) return;
        for (const rawZoneId of Object.keys(zoneState)) {
          const zoneId = String(rawZoneId || "").trim();
          if (!zoneId) continue;
          let el = null;
          try {
            // Use an attribute selector to avoid problems with IDs that start
            // with digits or contain characters that would make `#id` invalid.
            const selector = `[id="${zoneId.replace(/"/g, '\\"')}"]`;
            el = svg.querySelector(selector);
          } catch (err) {
            // Defensive fallback: try a simple contains-based search
            const nodes = svg.querySelectorAll('[id]');
            for (const n of nodes) {
              if (n.getAttribute('id') === zoneId) { el = n; break; }
            }
          }
          if (!el) continue;
          const st = zoneState[rawZoneId];
          if (st.highestPirads === null) {
            // explicitly set transparent fill for unmarked zones so they do
            // not fall back to browser defaults (black) or inherited CSS.
            el.setAttribute('fill', 'none');
            el.removeAttribute('data-pirads');
            el.removeAttribute('data-patterns');
          } else {
            // set explicit fill attribute to ensure it overrides CSS
            el.setAttribute('fill', getPiradsColor(st.highestPirads));
            el.setAttribute('data-pirads', String(st.highestPirads));
            if (st.count > 1) el.setAttribute('data-patterns', st.lesionIds.map(id => `pattern-${id}`).join(' '));
            else el.removeAttribute('data-patterns');
          }
        }
      }

      async function loadSvg(filename = 'prostate-map.svg') {
        try {
          const svgResp = await fetch('./' + filename + '?' + Date.now());
          if (!svgResp.ok) {
            console.warn('SVG not found');
            return null;
          }
          const svgText = await svgResp.text();
          const wrapper = document.createElement('div');
          // ensure the SVG is slotted into the component's named slot so it
          // appears inside the component shadow DOM (slot name: map-svg)
          wrapper.setAttribute('slot', 'map-svg');
          wrapper.innerHTML = svgText;
          // clear previous content
          while (container.firstChild) container.removeChild(container.firstChild);
          container.appendChild(wrapper);
          return wrapper.querySelector('svg');
        } catch (err) {
          console.warn('Failed to load SVG:', err);
          return null;
        }
      }

      async function loadDataset(name) {
        const resp = await fetch('./data/' + name);
        const json = await resp.json();
        currentData = json;
        // If the real component is present, set its `data` property so it
        // can validate and render using the bundled logic. Otherwise fall
        // back to manipulating the slotted SVG directly.
        if (customElements.get('prostate-mri-map')) {
          const comp = container;
          try {
            comp.data = json;
          } catch (err) {
            console.warn('Failed to set component data, falling back to inline renderer', err);
            const svg = container.querySelector('svg') || await loadSvg();
            const state = computeZoneState(json.lesions || []);
            applyZoneStylesToSvg(svg, state);
          }
        } else {
          const svg = container.querySelector('svg') || await loadSvg();
          const state = computeZoneState(json.lesions || []);
          applyZoneStylesToSvg(svg, state);
        }
      }

      document.getElementById('dataset').addEventListener('change', (e) => {
        loadDataset(e.target.value);
      });

      document.getElementById('map-selector').addEventListener('change', async (e) => {
        const selectedMap = e.target.value;
        try {
          // Clear existing SVG and load new one
          const svg = await loadSvg(selectedMap);
          if (!svg) {
            throw new Error(`Failed to load map: ${selectedMap}`);
          }
          // Re-render current dataset on the new map
          if (currentData) {
            if (customElements.get('prostate-mri-map')) {
              const comp = container;
              try {
                comp.data = currentData;
              } catch (err) {
                console.warn('Failed to set component data, falling back to inline renderer', err);
                const state = computeZoneState(currentData.lesions || []);
                applyZoneStylesToSvg(svg, state);
              }
            } else {
              const state = computeZoneState(currentData.lesions || []);
              applyZoneStylesToSvg(svg, state);
            }
          }
        } catch (error) {
          alert(`Error loading map "${selectedMap}": ${error.message}`);
          // Fall back to default map
          e.target.value = 'prostate-map.svg';
          // Try loading default map
          try {
            const svg = await loadSvg('prostate-map.svg');
            if (currentData && svg) {
              const state = computeZoneState(currentData.lesions || []);
              applyZoneStylesToSvg(svg, state);
            }
          } catch (fallbackError) {
            console.error('Failed to fall back to default map:', fallbackError);
          }
        }
      });

      // initial load
      (async () => {
        await loadSvg();
        await loadDataset('example-1.json');
      })();

      // Event listeners for demo
      const mapEl = document.getElementById('map');
      mapEl.addEventListener('zone-click', (e) => {
        console.log('Zone clicked:', e.detail);
      });
      mapEl.addEventListener('data-warning', (e) => {
        console.log('Data warning:', e.detail);
      });
    </script>

    <h2>Demo Instructions</h2>
    <p>
      This demo showcases the Prostate MRI Map Web Component. Use the controls above to change language and dataset.
      Click or tab to zones to see details. The component emits <code>zone-click</code> and <code>data-warning</code> events.
    </p>
    <h3>Event Listening Example</h3>
    <pre><code>// Listen to zone-click events
document.querySelector('prostate-mri-map').addEventListener('zone-click', (event) => {
  console.log('Zone clicked:', event.detail.zoneId, event.detail.lesions);
});

// Listen to data-warning events
document.querySelector('prostate-mri-map').addEventListener('data-warning', (event) => {
  console.log('Warnings:', event.detail.warnings);
});</code></pre>
  </body>
</html>
